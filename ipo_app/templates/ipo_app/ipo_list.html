<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bluestock IPO Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <header class="py-5 bg-light text-center">
    <h1 class="fw-bold">Welcome to Bluestock IPO Tracker</h1>
    <p class="text-muted">Track Upcoming, Ongoing, and Listed IPOs ‚Äî Download RHP & DRHP and view performance.</p>
  </header>

  <main class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>All IPOs</h2>
      <input type="text" id="searchInput" class="form-control w-50" placeholder="Search IPO by company name" />
    </div>

    <!-- IPO Tabs -->
    <ul class="nav nav-tabs mb-3" id="ipoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab">Upcoming IPO</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="ongoing-tab" data-bs-toggle="tab" data-bs-target="#ongoing" type="button" role="tab">Ongoing IPO</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="listed-tab" data-bs-toggle="tab" data-bs-target="#listed" type="button" role="tab">Listed IPO</button>
      </li>
    </ul>

    <!-- IPO Tab Content -->
    <div class="tab-content">
      <div class="tab-pane fade show active" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
        <div class="row" id="upcomingCards"></div>
      </div>
      <div class="tab-pane fade" id="ongoing" role="tabpanel" aria-labelledby="ongoing-tab">
        <div class="row" id="ongoingCards"></div>
      </div>
      <div class="tab-pane fade" id="listed" role="tabpanel" aria-labelledby="listed-tab">
        <div class="row" id="listedCards"></div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- IPO Script -->
  <script>
    async function fetchAllIPOs() {
      let ipos = [];
      let url = "/api/ipos/";
      const headers = {
        'Authorization': 'Token 95e5fce568a5ad76243dd7aea61a6050ce0eb06c',
        'Content-Type': 'application/json'
      };

      try {
        while (url) {
          const resp = await fetch(url, { headers });
          const res = await resp.json();

          if (Array.isArray(res.results)) {
            ipos.push(...res.results);
            url = res.next;
          } else if (Array.isArray(res)) {
            ipos = res;
            url = null;
          } else {
            console.error("Unexpected API response format:", res);
            break;
          }
        }

        console.log("üü¢ All IPOs fetched:", ipos);
        renderIPOs(ipos);
      } catch (e) {
        console.error("‚ùå Error loading IPOs:", e);
      }
    }

    function determineStatus(ipo) {
      const today = new Date();
      const open = new Date(ipo.open_date);
      const close = new Date(ipo.close_date);

      if (isNaN(open) || isNaN(close)) return "upcoming";
      if (today < open) return "upcoming";
      if (today >= open && today <= close) return "ongoing";
      return "listed";
    }

    function renderIPOs(ipos) {
      const containers = {
        upcoming: document.getElementById('upcomingCards'),
        ongoing: document.getElementById('ongoingCards'),
        listed: document.getElementById('listedCards')
      };

      Object.values(containers).forEach(el => el.innerHTML = '');

      ipos.forEach(ipo => {
        const status = determineStatus(ipo);
        const logo = ipo.logo || '/media/logos/default-logo.png';

        const card = `
          <div class="col-md-4 mb-4 ipo-card" data-name="${ipo.company_name.toLowerCase()}">
            <div class="card h-100 shadow-sm">
              <img src="${logo}" class="card-img-top" alt="${ipo.company_name}" onerror="this.src='/media/logos/default-logo.png'">
              <div class="card-body">
                <h5 class="card-title text-primary">${ipo.company_name}</h5>
                <p><strong>Price Band:</strong> ${ipo.price_band}</p>
                <p><strong>Open:</strong> ${ipo.open_date} | <strong>Close:</strong> ${ipo.close_date}</p>
                <p><strong>Issue Size:</strong> ${ipo.issue_size || 'N/A'}</p>
                <p><strong>Issue Type:</strong> ${ipo.issue_type || 'N/A'}</p>
                <p><strong>Listing Date:</strong> ${ipo.listing_date || 'N/A'}</p>
                <p><strong>RHP:</strong>
                  <a href="${ipo.rhp_pdf}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">Download</a>
                </p>
                <p><strong>DRHP:</strong>
                  <a href="${ipo.drhp_pdf}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">Download</a>
                </p>
                <span class="badge bg-${status === 'upcoming' ? 'warning' : status === 'ongoing' ? 'success' : 'secondary'} text-dark">${status}</span>
              </div>
            </div>
          </div>`;
          
        containers[status].insertAdjacentHTML('beforeend', card);
      });

      Object.entries(containers).forEach(([key, el]) => {
        if (!el.innerHTML.trim()) {
          el.innerHTML = `<p class="text-muted">No ${key} IPOs available.</p>`;
        }
      });

      // üîß Ensure visible tab-pane is correctly shown
      setTimeout(() => {
        const activeBtn = document.querySelector(".nav-link.active");
        if (activeBtn) {
          const targetId = activeBtn.getAttribute("data-bs-target");
          const targetPane = document.querySelector(targetId);
          if (targetPane) {
            document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("show", "active"));
            targetPane.classList.add("show", "active");
          }
        }
      }, 100);
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchAllIPOs();

      // Search
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          const query = this.value.trim().toLowerCase();
          document.querySelectorAll('.ipo-card').forEach(card => {
            const name = card.getAttribute('data-name');
            card.style.display = name.includes(query) ? '' : 'none';
          });
        });
      }
    });
  </script>
</body>
</html>
